{% extends 'base.html' %}

{% block head %} 
  <title> Search Employees </title>
{% endblock %}

{% block content %}

  <section id="portfolio">
    <div class="container">


      <div id='employee_search'>
        <div class="form-group row">
          <h3>Employee Search</h3>
        </div>

      <form id='search'>
            <!-- TODO: make disable select value to be possible to be selected for null -->
        <div class="container">
          <div class="form-group row">
            <span class="col-sm-3">
              <select name='company' id='company' class="form-control">
                <option style="color:#cccccc;" disabled selected>Company</option>
                {% for company in companies %}
                  <option value='{{ company.company_name }}'>
                    {{ company.company_name }}
                  </option>
                {% endfor %}
              </select>
            </span>
          </div>

          <div class="form-group row">
            <span class="col-sm-3">
              <select name='department' id='department' class="form-control">
                <option disabled selected>Department</option>
                {% for department in departments %}          
                  <option value='{{ department.department_name }}'>
                    {{ department.department_name }}
                  </option>
                {% endfor %}
              </select>
            </span>
          </div>

          <div class="form-group row">
            <span class="col-sm-3">
              <input type='text' name='first-name' id='first-name' placeholder="First Name">
              <input type='text' name='last-name' id='last-name' placeholder="Last Name">
            </span>
            </br>
            <input type='submit'> 
        </form>
      </div>
      <ul class="pagination" id="page-number"></ul>
    </div>
  </selection>

      <!-- no need to load entire thing. make a page break -->
      <div id="active_search_result">
        <ul id="emp_list">
          {% for employee in employees %}
              <li>
                <a href = '/employee/{{ employee.employee_id }}'>
                  {{ employee.first_name }} {{ employee.last_name }} 
                </a>
              </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </section>


  <script type="text/javascript">

///////////////////////////// Load page numbers //////////////////////
    var companySearch = "";
    var departmentSearch = "";
    var firstNameSearch = "";
    var lastNameSearch = "";
    var criteria;

    var continueLoading = true;
    var limit = 10;
    var pageLimit = 10;
    var pageOffset = 0;
    var employee_count = 0;
    var pageNumber = 0;

    function makePageNumbers(employee_count){
      if (employee_count % limit != Math.floor(employee_count % limit)){
        var pageNumbers = employee_count/limit + 1;
      }else{
        var pageNumbers = employee_count/limit;
      }
    }

    // show a list of page numbers to choose from
    function showPageNumbers(pageOffset, pageLimit){
      // empty the page nuber location
      $("#page-number").html('');      
      // TODO: limit the page numbers generated by pages
      // buling the page numbers
      for (var j=pageOffset; j<= pageLimit+pageOffset; j++){
        $("#page-number").append(" <li class='page-item'><a class = 'myButton' id='page-"+j+"'>" + (j+1) + "</a></li>")
      }
      // next
      $("#page-number").append(" <li class='page-item'><a id='page-next'> Next </a></li>")
      nextPage();
      // previous
      if(pageOffset != 0){
        $("#page-number").prepend(" <li class='page-item'><a id='page-prev'> Prev </a></li>")
        previousPage();
      }
    }

    function pageNumberDecorator(pageNumber){
      // turns on the underline of the page
      $("#page-"+pageNumber).css(
        'text-decoration', 'underline')
    }

    // activates next page numbers button
    function nextPage(){
      // bump up the offset by limit if the next is pressed
      $("#page-next").on('click', function(evt){
          pageOffset = pageOffset+pageLimit
          showPageNumbers(pageOffset, pageLimit);
          showClicked(pageOffset);
          pageButtonClickHandler();
        });
    }

    // activates previous page numbers button
    function previousPage(){
      $("#page-prev").on('click', function(evt){
          pageOffset = pageOffset-pageLimit
          showPageNumbers(pageOffset, pageLimit);
          showClicked(pageOffset);
          pageButtonClickHandler();
        });      
    }


/////////////// Load other page with page number when clicked //////////////////

    // when clicked the page number
    function pageButtonClickHandler(){
      $("a.myButton").click(function(){
        var page = $(this).attr('id');
        var pageNumber = Number(page.replace("page-",""));
        // tunrs off the underline of the page unused
        $("a.myButton").css(
          'text-decoration', 'none')
        // tunrs on the underline of the page used
        $("#page-"+pageNumber).css(
          'text-decoration', 'underline')
        showClicked(pageNumber)
      });
    }

    makePageNumbers({{employee_count}});
    showPageNumbers(pageOffset, pageLimit);
    pageNumberDecorator(pageNumber);
    pageButtonClickHandler();

    // load people on clicked page
    function showClicked(pageNumber){
      var offset2 = pageNumber * limit
      $("#emp_list").html('');
      var pageNumber;      
      $.get("/employee/data/"+offset2+"/"+limit, criteria).done(function(data){
        // are they submitting a first search? is pagenum 0?
        // ordered employee data received to be displayed
        for(var i = 0; i<limit; i++){
          if (continueLoading && data.employees[i].first_name){
            var nameListItem = '<li class="dym">'+data.employees[i].first_name+" "+data.employees[i].last_name+ '</li>'
            var employee_id = data.employees[i].employee_id
            $('#emp_list').append('<a href="/employee/'+ employee_id+ '/">'+nameListItem+'</a>');
          }
          else{
            window.stop();
          }
        }
      })
    }

///////////////////////////// Display search results //////////////////////

    // AJAX event handler to attach action onto a ID
    $('#search').on('submit', function(evt){
      // to stop going to the server side
      evt.preventDefault();
      continueLoading = true

      companySearch = $('#company').val();
      departmentSearch = $('#department').val();
      firstNameSearch = $('#first-name').val();
      lastNameSearch = $('#last-name').val();
      criteria = {"company_name" : companySearch,
                 "department_name" : departmentSearch,
                 "first_name" : firstNameSearch,
                 "last_name" : lastNameSearch
                 }
      showClicked(0);
    })

  </script>

{% endblock %}