{% extends 'base.html' %}

{% block head %} 
  <title> Search Employees </title>
{% endblock %}

{% block content %}

  <div id='employee_search'>

    <h3>Employee Search</h3>

    <form id='search'>
      <!-- TODO: make disable select value to be possible to be selected for null -->
      <select name='company' id='company'>
        <option></option>
        {% for company in companies %}
          <option value='{{ company.company_name }}'>
            {{ company.company_name }}
          </option>
        {% endfor %}
      </select>

      <select name='department' id='department'>
        <option></option>
        {% for department in departments %}          
          <option value='{{ department.department_name }}'>
            {{ department.department_name }}
          </option>
        {% endfor %}
      </select>
      <input type='text' name='first-name' id='first-name' placeholder="First Name">
      <input type='text' name='last-name' id='last-name' placeholder="Last Name">
      <input type='submit'> 
    </form>
  </div>
  <div id="page-number"></div>

  <!-- no need to load entire thing. make a page break -->
  <div id="active_search_result">
    <ul id="emp_list">
      {% for employee in employees %}
          <li>
            <a href = '/employee/{{ employee.employee_id }}'>
              {{ employee.first_name }} {{ employee.last_name }} 
            </a>
          </li>
      {% endfor %}
    </ul>
  </div>
  <script type="text/javascript">


///////////////////////////// Load page numbers //////////////////////

    var continueLoading = true
    var limit = 10
    var pageLimit = 10
    var pageOffset = 0

    if ({{employee_count}} % limit != Math.floor({{employee_count}} % limit)){
      var pageNumbers = {{employee_count}}/limit + 1
    }else{
      var pageNumbers = {{employee_count}}/limit
    }

    showPageNumbers(pageOffset, pageLimit);

    // show a list of page numbers to choose from
    function showPageNumbers(pageOffset, pageLimit){
      // empty the page nuber location
      $("#page-number").html('');      
      // buling the page numbers
      for (var j=pageOffset; j<= pageLimit+pageOffset; j++){
        $("#page-number").append(" <a class = 'myButton' id='page-"+j+"'>" + (j+1) + "</a>")
      }
      // next
      $("#page-number").append(" <a id='page-next'> Next </a>")
      nextPage();
      // previous
      if(pageOffset != 0){
        $("#page-number").prepend(" <a id='page-prev'> Prev </a>")
        previousPage();
      }
    }

    // turns on the underline of the page
    $("#page-0").css(
      'text-decoration', 'underline')

    // activates next page numbers button
    function nextPage(){
      // bump up the offset by limit if the next is pressed
      $("#page-next").on('click', function(evt){
          pageOffset = pageOffset+pageLimit
          showPageNumbers(pageOffset, pageLimit)
        });
    }

    // activates previous page numbers button
    function previousPage(){
      $("#page-prev").on('click', function(evt){
          pageOffset = pageOffset-pageLimit
          showPageNumbers(pageOffset, pageLimit)
        });      
    }

/////////////// Load other page with page number when clicked //////////////////

    // when clicked the page number
    $(".myButton").click(function(){
      var page = $(this).attr('id');
      var pageNumber = Number(page.replace("page-",""));
      // tunrs off the underline of the page unused
      $(".myButton").css(
        'text-decoration', 'none')
      // tunrs on the underline of the page used
      $("#page-"+pageNumber).css(
        'text-decoration', 'underline')
      showClicked(pageNumber)
    });

    // load people on clicked page
    function showClicked(pageNumber){
      var offset2 = pageNumber*limit
      console.log(offset2, limit)
      $("#emp_list").html('');
      $.get("/employee/data/"+offset2+"/"+limit, function(data){
        // ordered employee data received to be displayed
        for(var i = 0; i<limit; i++){
          if (continueLoading){
            var nameListItem = '<li class="dym">'+data.employees[i].first_name+" "+data.employees[i].last_name+ '</li>'
            var employee_id = data.employees[i].employee_id
            $('#emp_list').append('<a href="/employee/'+ employee_id+ '/">'+nameListItem+'</a>');
          }
          else{
            window.stop();
          }
        }
      })
    }

///////////////////////////// Display search results //////////////////////

    // AJAX event handler to attach action onto a ID
    $('#search').on('submit', function(evt){
      // to stop going to the server side
      evt.preventDefault();
      continueLoading = false

      // JQuery gets the submitted value by the id
      // figure out what the user typed in
      // not like regular JS the value is not value() but is val() in JQuery
      var companySearch = $('#company').val();
      var departmentSearch = $('#department').val();
      var firstNameSearch = $('#first-name').val();
      var lastNameSearch = $('#last-name').val();

      // // Ajax goes to the server side and make request
      // // attach the arg in the string as a parameter or have it as a second parameter

      // // Example on attatching the parameter in the string
      // $.get('/search_employees.json?first_name='+firstNameSearch, handleSearchResults);

      // Example on using the arguments as a second parameter
      // multiple values can be passed to the server side as a dictionary
      // style guide: make the route name to be .json to know you are getting JSON
      $.get('/search_employees.json', {"company_name" : companySearch,
                                       "department_name" : departmentSearch,
                                       "first_name" : firstNameSearch,
                                       "last_name" : lastNameSearch
                                      }).done(handleSearchResults);

      // The callback function definition
      // you will receive employee ids as the following format
      // employees = {'1': {'first_name': 'firsta', 'last_name' : 'lasta'}}
      function handleSearchResults(employees){
        // delete the enteire tinng (find the sytax)
        $('#active_search_result').empty();

        // Loop inside the query object returned, create name list HTML
        // Only first 10 employees are received for the initial loading
        var html_employees = '';
        for(var employee in employees){
          html_employees += ("<li><a href = '/employee/"
                              + employee
                              + "'>"
                              + employees[employee].first_name
                              + " "
                              + employees[employee].last_name
                              + "</a></li>");
        };
        $('#active_search_result').append('<ul>'+ html_employees + '</ul>');
      };
    })

  </script>

{% endblock %}